<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANNA</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        function MannaTracker() {
            const [allData, setAllData] = useState({});
            const [currentDate, setCurrentDate] = useState('');
            const [currentText, setCurrentText] = useState('');
            const [currentCompleted, setCurrentCompleted] = useState(false);
            const [copied, setCopied] = useState(false);

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            const getDayOfWeek = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return dayNames[date.getDay()];
            };

            const isWeekday = (dateStr) => {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                const day = date.getDay();
                return day >= 1 && day <= 6; // ì›”(1) ~ í† (6)
            };

            const getWeekNumber = (dateStr) => {
                const date = new Date(dateStr);
                const firstDay = new Date(date.getFullYear(), 0, 1);
                const pastDays = (date - firstDay) / 86400000;
                return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            };

            const loadDate = (dateStr) => {
                if (!dateStr) {
                    setCurrentText('');
                    setCurrentCompleted(false);
                    return;
                }

                if (allData[dateStr]) {
                    setCurrentText(allData[dateStr].text || '');
                    setCurrentCompleted(allData[dateStr].completed || false);
                } else {
                    setCurrentText('');
                    setCurrentCompleted(false);
                }
            };

            const saveCurrentDate = () => {
                if (currentDate && (currentText || currentCompleted)) {
                    setAllData(prev => ({
                        ...prev,
                        [currentDate]: {
                            text: currentText,
                            completed: currentCompleted,
                            dayOfWeek: getDayOfWeek(currentDate),
                            weekNumber: getWeekNumber(currentDate)
                        }
                    }));
                }
            };

            const handleDateChange = (newDate) => {
                saveCurrentDate();
                setCurrentDate(newDate);
                loadDate(newDate);
            };

            const handleTextChange = (value) => {
                setCurrentText(value);
            };

            const toggleComplete = () => {
                setCurrentCompleted(!currentCompleted);
            };

            const exportAllData = () => {
                saveCurrentDate();
                const data = {
                    allData: allData,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MANNA_ì „ì²´ë°ì´í„°.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const exportCombinedText = () => {
                saveCurrentDate();
                let combinedText = `MANNA ì „ì²´ ë…¹ì·¨\n\n`;
                
                const sortedDates = Object.keys(allData).sort();
                let currentYear = null;
                let currentWeek = null;

                sortedDates.forEach(date => {
                    const entry = allData[date];
                    const [year, month, day] = date.split('-');
                    const weekNum = entry.weekNumber;
                    
                    // ë…„ë„ê°€ ë°”ë€Œë©´
                    if (currentYear !== year) {
                        currentYear = year;
                        combinedText += `\n${'='.repeat(60)}\n`;
                        combinedText += `${year}ë…„\n`;
                        combinedText += `${'='.repeat(60)}\n\n`;
                    }
                    
                    // ì£¼ì°¨ê°€ ë°”ë€Œë©´
                    if (currentWeek !== weekNum) {
                        currentWeek = weekNum;
                        combinedText += `\n[ ${weekNum}ì£¼ì°¨ ]\n\n`;
                    }
                    
                    if (entry.text) {
                        combinedText += `ã€${entry.dayOfWeek}ìš”ì¼ ${month}/${day}ã€‘\n`;
                        combinedText += `${entry.text}\n\n`;
                    }
                });

                const blob = new Blob([combinedText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MANNA_ì „ì²´ë…¹ì·¨.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            setAllData(data.allData || {});
                            if (currentDate && data.allData[currentDate]) {
                                loadDate(currentDate);
                            }
                        } catch (error) {
                            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const copyToClipboard = async () => {
                saveCurrentDate();
                const data = {
                    allData: allData,
                    exportDate: new Date().toISOString()
                };
                try {
                    await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const goToToday = () => {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                handleDateChange(todayStr);
            };

            const changeDay = (offset) => {
                if (!currentDate) {
                    goToToday();
                    return;
                }
                const date = new Date(currentDate);
                date.setDate(date.getDate() + offset);
                const newDate = date.toISOString().split('T')[0];
                handleDateChange(newDate);
            };

            const totalEntries = Object.keys(allData).length;
            const completedEntries = Object.values(allData).filter(d => d.completed).length;

            // ìµœê·¼ 7ì¼ ë°ì´í„°
            const recentDates = Object.keys(allData)
                .sort((a, b) => b.localeCompare(a))
                .slice(0, 7);

            const dayOfWeek = getDayOfWeek(currentDate);
            const isValidDay = isWeekday(currentDate);
            const weekNum = currentDate ? getWeekNumber(currentDate) : null;

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4 flex-wrap gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="text-4xl">ğŸ</div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-amber-800">MANNA</h1>
                                        <p className="text-sm text-gray-600">
                                            ì´ {totalEntries}ì¼ ê¸°ë¡ | {completedEntries}ì¼ ì™„ë£Œ
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button
                                        onClick={copyToClipboard}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm"
                                    >
                                        {copied ? 'âœ“' : 'ğŸ“‹'} {copied ? 'ë³µì‚¬ë¨!' : 'ë³µì‚¬'}
                                    </button>
                                    <button
                                        onClick={exportAllData}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                    >
                                        ğŸ’¾ ì „ì²´ì €ì¥
                                    </button>
                                    <button
                                        onClick={exportCombinedText}
                                        className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-sm"
                                    >
                                        ğŸ“„ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
                                    </button>
                                    <label className="flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors cursor-pointer text-sm">
                                        ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°
                                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                                    </label>
                                </div>
                            </div>

                            {/* Date Input */}
                            <div className="flex gap-3 items-center mb-4">
                                <button
                                    onClick={() => changeDay(-1)}
                                    className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold"
                                >
                                    â—€ ì´ì „
                                </button>
                                <input
                                    type="date"
                                    value={currentDate}
                                    onChange={(e) => handleDateChange(e.target.value)}
                                    className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none text-lg font-semibold"
                                />
                                <button
                                    onClick={goToToday}
                                    className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600"
                                >
                                    ì˜¤ëŠ˜
                                </button>
                                <button
                                    onClick={() => changeDay(1)}
                                    className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold"
                                >
                                    ë‹¤ìŒ â–¶
                                </button>
                            </div>

                            {currentDate && (
                                <div className="text-center mb-2">
                                    <span className="text-2xl font-bold text-gray-800">
                                        {dayOfWeek}ìš”ì¼
                                    </span>
                                    {weekNum && (
                                        <span className="text-gray-500 ml-3">
                                            ({weekNum}ì£¼ì°¨)
                                        </span>
                                    )}
                                    {!isValidDay && (
                                        <span className="ml-3 text-red-500 font-semibold">
                                            âš ï¸ ì¼ìš”ì¼ì€ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Main Input */}
                        {currentDate && isValidDay && (
                            <div className="bg-white rounded-lg shadow-md p-5 mb-6">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-xl font-semibold text-gray-800">
                                        {currentDate} ({dayOfWeek}ìš”ì¼)
                                    </h3>
                                    <button
                                        onClick={toggleComplete}
                                        className="focus:outline-none hover:scale-110 transition-transform"
                                    >
                                        {currentCompleted ? (
                                            <svg className="text-green-500 w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="9 12 11 14 15 10" stroke="white" strokeWidth="2" fill="none"></polyline>
                                            </svg>
                                        ) : (
                                            <svg className="text-gray-300 w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                            </svg>
                                        )}
                                    </button>
                                </div>
                                <textarea
                                    value={currentText}
                                    onChange={(e) => handleTextChange(e.target.value)}
                                    placeholder="ì˜¤ëŠ˜ì˜ ë…¹ì·¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none resize-none"
                                    rows={10}
                                    onBlur={saveCurrentDate}
                                />
                                {currentText && (
                                    <div className="mt-2 text-sm text-gray-600">
                                        {currentText.length}ì
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Recent Entries */}
                        {recentDates.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-5 mb-6">
                                <h3 className="font-semibold text-gray-800 mb-3">ğŸ“… ìµœê·¼ ê¸°ë¡</h3>
                                <div className="space-y-2">
                                    {recentDates.map(date => {
                                        const entry = allData[date];
                                        const [year, month, day] = date.split('-');
                                        return (
                                            <div
                                                key={date}
                                                onClick={() => handleDateChange(date)}
                                                className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors"
                                            >
                                                <div className="flex-shrink-0">
                                                    {entry.completed ? (
                                                        <svg className="text-green-500 w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <polyline points="9 12 11 14 15 10" stroke="white" strokeWidth="2" fill="none"></polyline>
                                                        </svg>
                                                    ) : (
                                                        <svg className="text-gray-300 w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                        </svg>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="font-semibold text-gray-700">
                                                        {month}/{day} ({entry.dayOfWeek}ìš”ì¼)
                                                    </div>
                                                    {entry.text && (
                                                        <div className="text-sm text-gray-500 truncate">
                                                            {entry.text.substring(0, 50)}...
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Tips */}
                        <div className="bg-white rounded-lg shadow-md p-5">
                            <h3 className="font-semibold text-gray-800 mb-2">ğŸ’¡ ì‚¬ìš© íŒ</h3>
                            <ul className="text-sm text-gray-600 space-y-1">
                                <li>â€¢ ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ìš”ì¼ê³¼ ì£¼ì°¨ê°€ ê³„ì‚°ë©ë‹ˆë‹¤</li>
                                <li>â€¢ ì›”ìš”ì¼~í† ìš”ì¼ë§Œ ê¸°ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ì¼ìš”ì¼ ì œì™¸)</li>
                                <li>â€¢ ì‘ì„± í›„ ë‹¤ë¥¸ ë‚ ì§œë¡œ ì´ë™í•˜ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤</li>
                                <li>â€¢ 'ì „ì²´ì €ì¥'ìœ¼ë¡œ ì •ê¸°ì ìœ¼ë¡œ ë°±ì—…í•˜ì„¸ìš”</li>
                                <li>â€¢ 'í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°'ë¡œ ì—°ë„ë³„, ì£¼ì°¨ë³„ë¡œ ì •ë¦¬ëœ ì „ì²´ ë…¹ì·¨ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                                <li>â€¢ ìµœê·¼ ê¸°ë¡ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œë¡œ ì´ë™í•©ë‹ˆë‹¤</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MannaTracker />);
    </script>
</body>
</html>
